# Home Assistant Automations for ArduiBeeScale
#
# Copy this to /config/automations.yaml in Home Assistant
# OR
# Create individual automation files in /config/automations/
# Then reference them in configuration.yaml with:
#   automation: !include_dir_list automations/
#
# Date: 2025-11-16

# ==============================================================================
# ALERT 1: HIGH TEMPERATURE
# ==============================================================================
# Description: Alert when temperature exceeds 35Â°C for more than 5 minutes
# Why: Indicates potential stress for bees or ventilation issue

- id: "alert_high_temperature_ruche_001"
  alias: "Alerte TempÃ©rature Ã‰levÃ©e Ruche 001"
  description: "Notification when temperature exceeds 35Â°C"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_ruche_001
      above: 35
      for:
        minutes: 5

  condition:
    - condition: state
      entity_id: sensor.temperature_ruche_001
      state: "!=unavailable"

  action:
    # Persistent notification in HA
    - service: persistent_notification.create
      data:
        notification_id: "temp_high_alert_001"
        title: "âš ï¸ TempÃ©rature Ã‰levÃ©e Ruche 001"
        message: >-
          TempÃ©rature actuelle: {{ states('sensor.temperature_ruche_001') }}Â°C
          (Seuil alerte: 35Â°C)
          DurÃ©e: > 5 minutes

    # Email notification (if configured)
    - service: notify.email
      data:
        title: "ðŸŒ¡ï¸ Alerte TempÃ©rature Ruche 001"
        message: >-
          La tempÃ©rature de la ruche 001 dÃ©passe 35Â°C!

          TempÃ©rature actuelle: {{ states('sensor.temperature_ruche_001') }}Â°C
          HumiditÃ©: {{ states('sensor.humidity_ruche_001') }}%
          Heure de l'alerte: {{ now().strftime('%H:%M:%S') }}

          Recommandations:
          - VÃ©rifier la ventilation
          - Assurer un accÃ¨s Ã  l'eau
          - Surveiller le comportement des abeilles

    # Log to file
    - service: logbook.log
      data:
        name: "Alerte TempÃ©rature"
        message: "TempÃ©rature ruche 001: {{ states('sensor.temperature_ruche_001') }}Â°C"
        entity_id: sensor.temperature_ruche_001

  trigger_variables:
    temp: "{{ states('sensor.temperature_ruche_001') | float(0) }}"

---

# ==============================================================================
# ALERT 2: LOW TEMPERATURE
# ==============================================================================
# Description: Alert when temperature drops below 10Â°C
# Why: Indicates cold stress or heater malfunction

- id: "alert_low_temperature_ruche_001"
  alias: "Alerte TempÃ©rature Basse Ruche 001"
  description: "Alert when temperature is too low"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_ruche_001
      below: 10
      for:
        hours: 2

  action:
    - service: persistent_notification.create
      data:
        notification_id: "temp_low_alert_001"
        title: "â„ï¸ TempÃ©rature Basse Ruche 001"
        message: >-
          TempÃ©rature actuelle: {{ states('sensor.temperature_ruche_001') }}Â°C
          (Alerte < 10Â°C)

    - service: notify.email
      data:
        title: "â„ï¸ Alerte TempÃ©rature Basse"
        message: >-
          TempÃ©rature anormalement basse dÃ©tectÃ©e!
          TempÃ©rature: {{ states('sensor.temperature_ruche_001') }}Â°C

---

# ==============================================================================
# ALERT 3: LOW BATTERY
# ==============================================================================
# Description: Alert when battery level drops below 20%
# Why: Indicates need for battery replacement

- id: "alert_low_battery_ruche_001"
  alias: "Alerte Batterie Faible Ruche 001"
  description: "Notification when battery is low (<20%)"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.batterie_ruche_001
      below: 20

  action:
    - service: persistent_notification.create
      data:
        notification_id: "battery_low_alert_001"
        title: "ðŸ”‹ Batterie Faible Ruche 001"
        message: >-
          Batterie: {{ states('sensor.batterie_ruche_001') }}%
          Tension: {{ states('sensor.tension_batterie_ruche_001') }}V

          Action: Remplacer les piles dÃ¨s que possible

    - service: notify.email
      data:
        title: "ðŸ”‹ Batterie Faible - Action Requise"
        message: >-
          La batterie de la ruche 001 est faible:
          {{ states('sensor.batterie_ruche_001') }}%
          Tension: {{ states('sensor.tension_batterie_ruche_001') }}V

          Veuillez remplacer les piles (4x AA) dÃ¨s que possible.

---

# ==============================================================================
# ALERT 4: CRITICAL BATTERY
# ==============================================================================
# Description: Alert when battery drops below 5%
# Why: System will stop working very soon

- id: "alert_critical_battery_ruche_001"
  alias: "Alerte Batterie Critique Ruche 001"
  description: "Alert when battery is critical (<5%)"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.batterie_ruche_001
      below: 5

  action:
    - service: persistent_notification.create
      data:
        notification_id: "battery_critical_alert_001"
        title: "ðŸš¨ BATTERIE CRITIQUE Ruche 001"
        message: >-
          BATTERIE CRITIQUE: {{ states('sensor.batterie_ruche_001') }}%

          âš ï¸ DANGER: Le systÃ¨me arrÃªtera bientÃ´t de fonctionner!
          Remplacez immÃ©diatement les piles!

    - service: notify.email
      data:
        title: "ðŸš¨ BATTERIE CRITIQUE - REMPLACER IMMÃ‰DIATEMENT"
        message: >-
          ALERTE URGENTE!

          La batterie de la ruche 001 est CRITIQUE:
          {{ states('sensor.batterie_ruche_001') }}%
          Tension: {{ states('sensor.tension_batterie_ruche_001') }}V

          âš ï¸ Le systÃ¨me s'arrÃªtera trÃ¨s bientÃ´t!

          ACTION IMMÃ‰DIATE REQUISE:
          1. Vous rendre Ã  la ruche
          2. Remplacer les 4 piles AA
          3. RedÃ©marrer le systÃ¨me

---

# ==============================================================================
# ALERT 5: NO DATA RECEIVED
# ==============================================================================
# Description: Alert when no data received for 4 hours
# Why: Indicates WiFi, MQTT, or sensor failure

- id: "alert_no_data_ruche_001"
  alias: "Alerte Pas de DonnÃ©es Ruche 001"
  description: "Alert when no data received for 4 hours"
  mode: single

  trigger:
    - platform: state
      entity_id: sensor.temperature_ruche_001
      to: "unavailable"
      for:
        hours: 4

  action:
    - service: persistent_notification.create
      data:
        notification_id: "no_data_alert_001"
        title: "âŒ Pas de DonnÃ©es Ruche 001"
        message: >-
          Aucune donnÃ©es reÃ§ues depuis 4 heures!

          Causes possibles:
          - Perte de connexion WiFi
          - Batterie Ã©puisÃ©e
          - DÃ©faillance du capteur
          - ProblÃ¨me MQTT

          Actions Ã  tenter:
          1. VÃ©rifier la connexion WiFi
          2. VÃ©rifier la batterie
          3. RedÃ©marrer le systÃ¨me Arduino

    - service: notify.email
      data:
        title: "âŒ Perte de Connexion Ruche 001"
        message: >-
          La ruche 001 ne transmet plus de donnÃ©es depuis 4 heures!

          DerniÃ¨re donnÃ©es: {{ as_timestamp(state_attr('sensor.temperature_ruche_001', 'last_updated')) | timestamp_custom('%Y-%m-%d %H:%M:%S') }}

          Diagnostique suggÃ©rÃ©:
          - WiFi dÃ©connectÃ©?
          - Batterie Ã©puisÃ©e?
          - Capteur en panne?

---

# ==============================================================================
# ALERT 6: ABNORMAL WEIGHT LOSS
# ==============================================================================
# Description: Alert if weight loss > 5kg in 24 hours (harvest or queen death)
# Why: Could indicate significant event in hive

- id: "alert_abnormal_weight_loss_ruche_001"
  alias: "Alerte Perte Poids Anormale Ruche 001"
  description: "Alert if weight loss exceeds normal range"
  mode: single

  trigger:
    - platform: template
      value_template: >
        {% set current = states('sensor.poids_ruche_001') | float(0) %}
        {% set previous = states('sensor.poids_ruche_001', rounded_seconds=86400) | float(0) %}
        {{ (previous - current) > 5 and current > 0 }}

  action:
    - service: persistent_notification.create
      data:
        notification_id: "weight_loss_alert_001"
        title: "ðŸ“‰ Perte de Poids Anormale Ruche 001"
        message: >-
          Perte de poids importante dÃ©tectÃ©e!

          Poids actuel: {{ states('sensor.poids_ruche_001') }}kg
          Perte estimÃ©e: > 5kg en 24h

          Causes possibles:
          - RÃ©colte de miel?
          - Essaimage?
          - ProblÃ¨me grave dans la ruche

          Recommandation: Inspection manuelle requise

    - service: notify.email
      data:
        title: "ðŸ“‰ Perte de Poids Importante - Inspection RecommandÃ©e"
        message: >-
          Perte de poids anormale dÃ©tectÃ©e Ã  la ruche 001:
          > 5kg en 24 heures

          Poids actuel: {{ states('sensor.poids_ruche_001') }}kg

          Causes possibles:
          - RÃ©colte de miel
          - Essaimage ou dÃ©sertion
          - ProblÃ¨me sanitaire

          Une inspection manuelle est recommandÃ©e.

---

# ==============================================================================
# ALERT 7: HUMIDITY OUT OF RANGE
# ==============================================================================
# Description: Alert if humidity outside 30-80% range
# Why: Indicates ventilation or condensation problems

- id: "alert_humidity_high_ruche_001"
  alias: "Alerte HumiditÃ© Ã‰levÃ©e Ruche 001"
  description: "Alert when humidity > 80%"
  mode: single

  trigger:
    - platform: numeric_state
      entity_id: sensor.humidity_ruche_001
      above: 80
      for:
        hours: 2

  action:
    - service: persistent_notification.create
      data:
        notification_id: "humidity_high_alert_001"
        title: "ðŸ’§ HumiditÃ© Ã‰levÃ©e Ruche 001"
        message: >-
          HumiditÃ©: {{ states('sensor.humidity_ruche_001') }}%
          (Alerte: > 80%)

          Recommandations:
          - AmÃ©liorer la ventilation
          - Ajouter des trous d'aÃ©ration
          - VÃ©rifier les fuites d'eau

    - service: notify.email
      data:
        title: "ðŸ’§ HumiditÃ© Ã‰levÃ©e - Ventilation Ã  AmÃ©liorer"
        message: >-
          L'humiditÃ© de la ruche 001 est trop Ã©levÃ©e:
          {{ states('sensor.humidity_ruche_001') }}%

          Cela peut causer des problÃ¨mes de moisissure et de maladies.

---

# ==============================================================================
# DAILY SUMMARY REPORT
# ==============================================================================
# Description: Send daily summary at 20:00
# Why: Provides overview of hive conditions

- id: "daily_summary_ruche_001"
  alias: "Rapport Quotidien Ruche 001"
  description: "Send daily summary report at 20:00"
  mode: single

  trigger:
    - platform: time
      at: "20:00:00"

  action:
    - service: notify.email
      data:
        title: "ðŸ“‹ Rapport Quotidien Ruche 001"
        message: >
          **Rapport Quotidien - {{ now().strftime('%d %B %Y') }}**

          **TempÃ©rature:**
          - Actuelle: {{ states('sensor.temperature_ruche_001') }}Â°C
          - Min: {{ state_attr('sensor.temperature_ruche_001', 'min_value') | default('N/A') }}Â°C
          - Max: {{ state_attr('sensor.temperature_ruche_001', 'max_value') | default('N/A') }}Â°C

          **HumiditÃ©:**
          - Actuelle: {{ states('sensor.humidity_ruche_001') }}%

          **Poids:**
          - Actuel: {{ states('sensor.poids_ruche_001') }}kg
          - Net: {{ states('sensor.poids_net_ruche_001') | default('N/A') }}kg

          **Batterie:**
          - {{ states('sensor.batterie_ruche_001') }}% ({{ states('sensor.tension_batterie_ruche_001') }}V)

          **Statuts:**
          - TempÃ©rature: {{ states('sensor.etat_temperature_ruche_001') }}
          - Batterie: {{ states('sensor.etat_batterie_ruche_001') }}

          âœ… Tous les systÃ¨mes fonctionnent correctement.

    - service: logbook.log
      data:
        name: "Rapport Quotidien"
        message: "Rapport quotidien envoyÃ© pour ruche 001"

---

# ==============================================================================
# WEEKLY SUMMARY REPORT
# ==============================================================================
# Description: Send weekly summary every Sunday at 19:00

- id: "weekly_summary_ruche_001"
  alias: "Rapport Hebdomadaire Ruche 001"
  description: "Send weekly summary report"
  mode: single

  trigger:
    - platform: time
      at: "19:00:00"
    - platform: time_pattern
      weekday: "sun"

  action:
    - service: notify.email
      data:
        title: "ðŸ“Š Rapport Hebdomadaire Ruche 001"
        message: >
          **Rapport Hebdomadaire**

          **Semaine du {{ (now() - timedelta(days=7)).strftime('%d %B') }}
          au {{ now().strftime('%d %B %Y') }}**

          **Statistiques TempÃ©rature:**
          - Moyenne: {{ state_attr('sensor.temperature_ruche_001', 'mean') | default('N/A') }}Â°C
          - Min: {{ state_attr('sensor.temperature_ruche_001', 'min_value') | default('N/A') }}Â°C
          - Max: {{ state_attr('sensor.temperature_ruche_001', 'max_value') | default('N/A') }}Â°C

          **Bilan Poids:**
          - Poids actuel: {{ states('sensor.poids_ruche_001') }}kg
          - Changement semaine: {{ state_attr('sensor.poids_ruche_001', 'change_week') | default('N/A') }}kg

          **Alertes cette semaine:**
          - Aucune alerte majeure âœ…

          **Recommandations:**
          - Continuer Ã  surveiller
          - VÃ©rifier batterie mensuellement
          - Inspecter manuellement avant rÃ©colte

---

# ==============================================================================
# TEST AUTOMATION (For verification)
# ==============================================================================
# Description: Test automation that sends message when triggered manually

- id: "test_automation_ruche_001"
  alias: "Test - Alerte Test Ruche 001"
  description: "Test automation for debugging (comment out after testing)"
  mode: single

  trigger:
    # Manual trigger: Home Assistant â†’ Developer Tools â†’ Automation â†’ Select this automation â†’ Test
    platform: event
    event_type: "automation_test"
    event_data:
      automation_id: "test_automation_ruche_001"

  action:
    - service: persistent_notification.create
      data:
        notification_id: "test_alert_001"
        title: "âœ… Test Automatisation RÃ©ussi"
        message: >
          Cette automatisation fonctionne correctement!

          DonnÃ©es actuelles:
          - TempÃ©rature: {{ states('sensor.temperature_ruche_001') }}Â°C
          - HumiditÃ©: {{ states('sensor.humidity_ruche_001') }}%
          - Poids: {{ states('sensor.poids_ruche_001') }}kg
          - Batterie: {{ states('sensor.batterie_ruche_001') }}%

    - service: notify.email
      data:
        title: "âœ… Test Notification Email"
        message: "Si vous recevez cet email, les notifications fonctionnent!"

---

# ==============================================================================
# NOTES FOR CUSTOMIZATION
# ==============================================================================
#
# To add these automations to Home Assistant:
#
# 1. Copy the entire content of this file
# 2. In Home Assistant, go to Settings â†’ Automations & Scenes
# 3. Click "Create Automation"
# 4. Click three dots â†’ Edit in YAML
# 5. Paste each automation block (between the "---" lines)
#
# OR
#
# 1. Save this file as /config/automations/arduibeescale_001.yaml
# 2. In configuration.yaml, add:
#    automation: !include_dir_list automations/
# 3. Restart Home Assistant
#
# CUSTOMIZATION HINTS:
# - Change entity IDs (sensor.temperature_ruche_001) to match your setup
# - Adjust thresholds (35Â°C, 20%, etc.) to your preferences
# - Modify email recipients and messages
# - Add additional conditions (e.g., only alert during certain hours)
# - Add multiple hives by duplicating and changing IDs
#
# TESTING:
# - Settings â†’ Automations & Scenes â†’ Automation
# - Click "Test automation" button next to automation name
# - Check Services and Logs for debugging
#
# ==============================================================================
